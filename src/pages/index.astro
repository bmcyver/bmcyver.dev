---
import DiscordPresence from '@/components/bento/DiscordPresence'
import GithubCalendar from '@/components/bento/GithubCalendar'
import SpotifyPresence from '@/components/bento/SpotifyPresence'
import WakatimeGraph from '@/components/bento/WakatimeGraph'
import Link from '@/components/Link.astro'
import TreeBackground from '@/components/TreeBackground.astro'
import AvatarComponent from '@/components/ui/avatar'
import { badgeVariants } from '@/components/ui/badge'
import Layout from '@/layouts/Layout.astro'
import { getCombinedReadingTime, parseAuthors } from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import { getCollection } from 'astro:content'

const latestPost = await getCollection('blog').then((posts) =>
  posts
    .sort(
      (a, b) =>
        new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
    )
    .filter((post) => import.meta.env.DEV || !post.data.draft)
    .at(0),
)

let formattedDate, readTime, authors

if (latestPost) {
  formattedDate = formatDate(latestPost.data.date)
  readTime = await getCombinedReadingTime(latestPost.id)
  authors = await parseAuthors(latestPost.data.authors ?? [])
}
---

<Layout class="max-w-3xl">
  <section
    role="list"
    class="mx-auto grid max-w-[375px] grid-cols-1 gap-4 px-4 [grid-template-areas:'a'_'b'_'c'_'d'_'e'] *:rounded-3xl *:bg-cover *:bg-center *:bg-no-repeat md:max-w-screen-md md:grid-cols-3 md:[grid-template-areas:'a_a_b'_'c_d_d'_'e_e_f']"
  >
    <!-- About Me -->
    <div
      role="listitem"
      aria-label="About me"
      class="card-base group relative col-span-1 overflow-hidden border [grid-area:a]"
    >
      <TreeBackground />
      <div class="relative flex flex-col space-y-1.5 p-6">
        <h3 class="text-3xl leading-none font-semibold">Hey, I'm bmcyver!</h3>
      </div>
      <div class="text-muted-foreground relative p-6 pt-0 text-sm">
        <p class="mb-2">
          I'm a student studying <strong>web security</strong> and <strong
            >binary exploitation</strong
          >.
        </p>
        <p class="mb-2">
          Currently, I'm participating in CTFs with the
          <a href="https://deadsec.team" class="font-semibold hover:underline"
            >DeadSec</a
          >
        </p>
        <p class="mb-2">
          I also enjoy playing <strong>Genshin Impact</strong> in my free time.
        </p>
        <p class="mt-4">
          <a
            href="/about"
            class="text-primary inline-flex items-center font-medium hover:underline"
          >
            Learn more about me
            <Icon name="lucide:arrow-right" class="ml-1" size={14} />
          </a>
        </p>
      </div>
    </div>

    <!-- Discord Activity -->
    <div
      role="listitem"
      aria-label="Discord status"
      class="card-base group relative overflow-hidden border [grid-area:b]"
    >
      <TreeBackground size="sm" />
      <DiscordPresence client:load />
    </div>

    <!-- Wakatime Graph -->
    <div
      role="listitem"
      aria-label="Wakatime coding time"
      class="card-base group relative aspect-[4/3] max-h-[240px] w-full overflow-hidden border [grid-area:c] md:aspect-square"
    >
      <TreeBackground size="sm" density="low" />
      <WakatimeGraph client:load />
    </div>

    <!-- Github Calendar -->
    <div
      role="listitem"
      aria-label="Recent GitHub activity"
      class="card-base group relative overflow-hidden border p-4 [grid-area:d]"
    >
      <TreeBackground density="medium" />
      <GithubCalendar client:load />
    </div>

    <!-- Recent Post -->
    <div
      role="listitem"
      aria-label="Latest blog post"
      class="card-base group relative overflow-hidden border [grid-area:e] sm:block"
    >
      <TreeBackground density="medium" />
      {
        latestPost && (
          <div class="relative z-10 flex h-full flex-col p-5 md:p-6">
            <div class="flex grow flex-col gap-3">
              <div class="relative">
                <a
                  href={`/blog/${latestPost.id}`}
                  aria-label={`Read full post: ${latestPost.data.title}`}
                  class="group/title focus-visible:ring-primary inline-block rounded-sm hover:underline focus:outline-none focus-visible:ring-2"
                >
                  <h4 class="group-hover:text-primary group/title:hover:text-primary line-clamp-2 text-lg leading-snug font-semibold transition-colors md:text-xl">
                    {latestPost.data.title}
                  </h4>
                </a>
              </div>

              <p class="text-muted-foreground line-clamp-3 min-h-[3.4em] text-sm">
                {latestPost.data.description}
              </p>

              <div class="text-muted-foreground flex flex-wrap items-center gap-x-2 gap-y-1 text-xs">
                {authors && authors.length > 0 && (
                  <>
                    {authors.map((author) => (
                      <span class="flex items-center gap-1">
                        <AvatarComponent
                          client:load
                          src={author.avatar}
                          alt={author.name}
                          fallback={author.name[0]}
                          className="size-4 rounded-full"
                        />
                        <span class="max-w-[90px] truncate">{author.name}</span>
                      </span>
                    ))}
                    <span aria-hidden="true" class="opacity-60">
                      ·
                    </span>
                  </>
                )}
                <span class="truncate">{formattedDate}</span>
                <span aria-hidden="true" class="opacity-60">
                  ·
                </span>
                <span class="truncate">{readTime}</span>
              </div>

              <div class="mt-auto flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex flex-wrap gap-2">
                  {latestPost.data.tags && (
                    <>
                      {latestPost.data.tags.slice(0, 3).map((tag: string) => (
                        <a
                          href={`/tags/${tag}`}
                          class={
                            badgeVariants({ variant: 'secondary' }) +
                            ' flex items-center gap-1 px-2 py-0.5 text-xs'
                          }
                        >
                          <Icon name="lucide:hash" class="size-3" />
                          {tag}
                        </a>
                      ))}
                      {latestPost.data.tags.length > 3 && (
                        <span class="text-muted-foreground self-center text-xs">
                          +{latestPost.data.tags.length - 3} more
                        </span>
                      )}
                    </>
                  )}
                </div>
                <Link
                  href={`/blog/${latestPost.id}`}
                  class="text-primary hidden items-center gap-1 text-sm font-medium hover:underline md:inline-flex"
                >
                  Read more
                  <Icon name="lucide:arrow-right" class="size-3.5" />
                </Link>
              </div>
            </div>
          </div>
        )
      }
    </div>

    <!-- Spotify Activity (모바일 숨김) -->
    <div
      role="listitem"
      aria-label="Current Spotify track"
      class="card-base group relative hidden overflow-hidden border [grid-area:f] md:block"
    >
      <TreeBackground size="sm" density="low" />
      <SpotifyPresence client:load />
    </div>
  </section>
</Layout>
